<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rhythm Hero</title>
<link rel="icon" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Rhythm Hero">
</head>
<style>
html,body{
  margin:0;
  padding:0;
  background:black;
  overflow:hidden;
  font-family:sans-serif;
}

/* ê³µí†µ í™”ë©´ */
.screen{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color:white;
  background:black;
}

/* ë²„íŠ¼ */
button{
  font-size:20px;
  padding:14px 30px;
  margin:10px;
}

/* ê²Œì„ í™”ë©´ */
#game{
  display:none;
  position:relative;
  width:100%;
  height:100vh;
  background:#000;
}

.lane{
  position:absolute;
  width:25%;
  height:100%;
  border-left:1px solid rgba(255,255,255,0.2);
}
.lane:nth-child(1){left:0%}
.lane:nth-child(2){left:25%}
.lane:nth-child(3){left:50%}
.lane:nth-child(4){left:75%}

#hitLine{
  position:absolute;
  bottom:120px;
  width:100%;
  height:4px;
  background:yellow;
}

.note{
  position:absolute;
  top:-30px;
  left:5%;
  width:90%;
  height:18px;
  background:#00ffff;
  box-shadow:0 0 10px #00ffff;
}

#score{
  position:fixed;
  top:20px;
  left:20px;
  font-size:20px;
}
</style>
</head>

<body>

<!-- ë…¸ë˜ ì„ íƒ -->
<div id="select" class="screen">
  <h1>ğŸµ ë…¸ë˜ ì„ íƒ</h1>
  <button onclick="previewSong(0)">ğŸ¶ Song 1</button>
  <button onclick="previewSong(1)">ğŸ”¥ Song 2</button>
  <button onclick="previewSong(2)">âš¡ Song 3</button>
  <button onclick="startSelected()">â–¶ START</button>
</div>

<!-- ê²Œì„ -->
<div id="game">
  <div class="lane"></div>
  <div class="lane"></div>
  <div class="lane"></div>
  <div class="lane"></div>
  <div id="hitLine"></div>
  <div id="score">SCORE: 0</div>
</div>

<audio id="music"></audio>
<audio id="preview"></audio>

<script>
/* ë…¸ë˜ ëª©ë¡ */
const songs=[
  {src:"music1.mp3", beat:200},
  {src:"music2.mp3", beat:160},
  {src:"music3.mp3", beat:120}
];

const selectScreen=document.getElementById("select");
const game=document.getElementById("game");
const music=document.getElementById("music");
const preview=document.getElementById("preview");
const lanes=document.querySelectorAll(".lane");
const scoreUI=document.getElementById("score");

let audioCtx, analyser, dataArray;
let lastBeat=0;
let beatGap=200;
let score=0;
let previewIndex=-1;

/* ğŸ§ ë¯¸ë¦¬ ë“£ê¸° */
function previewSong(i){
  if(previewIndex===i){
    preview.pause();
    previewIndex=-1;
    return;
  }
  previewIndex=i;
  preview.src=songs[i].src;
  preview.currentTime=15;
  preview.volume=0.7;
  preview.play();
}

/* â–¶ ê²Œì„ ì‹œì‘ */
function startSelected(){
  if(previewIndex===-1){
    alert("ë…¸ë˜ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
    return;
  }
  preview.pause();
  selectSong(previewIndex);
}

function selectSong(i){
  music.src=songs[i].src;
  beatGap=songs[i].beat;
  selectScreen.style.display="none";
  game.style.display="block";
  startGame();
}

/* ğŸ® ê²Œì„ ë¡œì§ */
function startGame(){
  music.play();

  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const source=audioCtx.createMediaElementSource(music);
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=256;
  dataArray=new Uint8Array(analyser.frequencyBinCount);

  source.connect(analyser);
  analyser.connect(audioCtx.destination);

  requestAnimationFrame(loop);
}

function loop(time){
  analyser.getByteFrequencyData(dataArray);

  let bass=0;
  for(let i=0;i<8;i++) bass+=dataArray[i];

  if(bass>180 && time-lastBeat>beatGap){
    spawnNote();
    lastBeat=time;
  }

  moveNotes();
  requestAnimationFrame(loop);
}

function spawnNote(){
  const lane=lanes[Math.floor(Math.random()*4)];
  const note=document.createElement("div");
  note.className="note";
  lane.appendChild(note);
}

function moveNotes(){
  document.querySelectorAll(".note").forEach(note=>{
    note.style.top=(note.offsetTop+6)+"px";
    if(note.offsetTop>innerHeight){
      note.remove();
      score-=50;
      updateScore();
    }
  });
}

/* ì…ë ¥ */
addEventListener("pointerdown",()=>{
